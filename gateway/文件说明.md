# 文件说明 — AgentLoop 全面优化 (Phase 1-6)

## 新增文件

### domain/service/
| 文件 | 说明 |
|:---|:---|
| `guardrails.go` | CostGuard (token + 时间预算) / ContextGuard (上下文窗口保护) / LoopDetector (滑动窗口) |
| `llm_errors.go` | 6 种结构化 LLM 错误 + `ClassifyError` 自动分类 |
| `tool_cache.go` | 工具结果短期缓存 (TTL 30s, SHA256 key, LRU 驱逐) |
| `trace.go` | 请求级 Trace ID (crypto/rand, context 注入) |
| `config_watcher.go` | JSON 配置文件热更新 (5s 轮询, RWMutex 并发安全) |
| `guardrails_test.go` | CostGuard / ContextGuard / LoopDetector / sanitize / LLMError 测试 (18) |
| `tool_cache_test.go` | ToolCache + TraceID 测试 (9) |

### domain/runner/
| 文件 | 说明 |
|:---|:---|
| `adapter.go` | EmbeddedRunner ↔ AgentLoop 适配层 (实现 ModelClient + ToolExecutor) |

### infrastructure/llm/
| 文件 | 说明 |
|:---|:---|
| `circuit_breaker.go` | 3-state 断路器 (Closed / Open / HalfOpen) |
| `circuit_breaker_test.go` | 断路器状态机测试 (8) |
| `openai_builtin_test.go` | SSE parser 测试 (8) |

### infrastructure/monitoring/
| 文件 | 说明 |
|:---|:---|
| `prometheus.go` | Prometheus `/metrics` HTTP handler (零外部依赖) |
| `metrics_hook.go` | AgentHook → Monitor 自动指标采集 |
| `tracer.go` | OTel-compatible Tracer (Span/SpanEvent/context 传播/ring buffer) |

### domain/agent/
| 文件 | 说明 |
|:---|:---|
| `dag.go` | DAG 编排器 (拓扑排序 + Kahn 环检测 + 并行执行 + 级联跳过) |
| `dag_test.go` | DAG 测试 (链式/扇出/环/级联/去重) |

### infrastructure/eventbus/
| 文件 | 说明 |
|:---|:---|
| `persistent_bus.go` | WAL 持久化 EventBus (JSON lines + Replay + Truncate + Rotation) |
| `persistent_bus_test.go` | 持久化总线测试 (4) |

## 改动文件

| 文件 | 改动 |
|:---|:---|
| `agent_loop.go` | 防护栏 + toolCache + traceID + LLM 摘要压缩 + 多模态 |
| `openai_builtin.go` | SSE tool call `Index` 修复 |
| `router.go` | 延迟追踪 + per-provider 断路器 + ProviderStatus |
| `prompt_engine.go` | Assembly 缓存 (double-check locking) |
