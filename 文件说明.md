# 文件说明

## Phase 5 新增文件

| 文件 | 用途 |
|------|------|
| `gateway/internal/interfaces/repl/repl.go` | REPL 交互式终端 (`gateway repl`) |
| `gateway/internal/interfaces/http/handlers/openai_handler.go` | OpenAI 兼容 API |
| `gateway/internal/interfaces/telegram/media.go` | Telegram 媒体提取和下载 |
| `ai-service/src/infrastructure/media/__init__.py` | Python 媒体理解模块 |
| `ai-service/src/infrastructure/media/handler.py` | 媒体包 init |

## Phase 6 新增文件

| 文件 | 用途 |
|------|------|
| `gateway/internal/domain/service/heartbeat.go` | 心跳系统 (HEARTBEAT.md 周期执行) |
| `gateway/internal/infrastructure/plugin/manifest.go` | 插件 manifest 解析/校验 |
| `gateway/internal/infrastructure/tool/browser_tools.go` | 浏览器工具 ×4 |
| `gateway/internal/infrastructure/tool/memory_tool.go` | 记忆搜索/存储工具 ×2 |

## 修改文件

| 文件 | 变更 |
|------|------|
| `gateway/cmd/gateway/main.go` | 添加 repl/version/help 子命令 |
| `gateway/internal/application/app.go` | 暴露 DI 访问器 |
| `gateway/internal/interfaces/http/server.go` | 注册 /v1 OpenAI 路由 |
| `gateway/internal/infrastructure/config/config.go` | 添加 HeartbeatConfig |
| `gateway/internal/infrastructure/tool/executor.go` | 注册浏览器工具 (5→9) |
| `gateway/internal/application/usecase/process_message_test.go` | 修复 Mock |
| `gateway/internal/application/usecase/process_message_command_test.go` | 修复 Mock |

## Phase 3.5 新增文件

| 文件 | 用途 |
|------|------|
| `gateway/internal/infrastructure/plugin/extension_registry.go` | 插件工具注册桥接 (plugin → tool registry) |
| `gateway/internal/infrastructure/tool/browser_tools_test.go` | Browser tools 单元测试 (×12) |
| `gateway/internal/infrastructure/plugin/plugin_loader_test.go` | Plugin Loader + ExtensionRegistry 测试 (×8) |

## Phase 3.5 修改文件

| 文件 | 变更 |
|------|------|
| `gateway/internal/interfaces/telegram/adapter.go` | `IncomingMessage` 新增 `Media`/`MediaData`; `handleUpdate` 媒体提取 |
| `gateway/internal/interfaces/telegram/media.go` | 新增 `MediaProcessor` (base64/转录/文档内容注入) |
| `gateway/internal/application/app.go` | `telegramMessageHandler` 集成 `MediaProcessor` + `mapMediaType` |
| `gateway/internal/infrastructure/tool/browser_tools.go` | stub → `SkillExecutor` gRPC 委托 |
| `gateway/internal/infrastructure/tool/executor.go` | 新增 `skillExec` 字段 |
| `gateway/internal/infrastructure/grpc/ai_client.go` | 新增 `AIClientSkillAdapter` |
| `gateway/internal/infrastructure/plugin/loader.go` | `ioutil` → `os` 废弃 API 修复 |

## Phase 4 新增文件

| 文件 | 用途 |
|------|------|
| `gateway/internal/interfaces/telegram/inbound_buffer.go` | 入站消息缓冲器 (碎片重组/防抖/相册合并) |
| `gateway/internal/application/usecase/compaction.go` | 对话历史自动压缩 (>30条时AI摘要) |
| `gateway/internal/infrastructure/grpc/model_failover.go` | 多模型容灾 + cooldown 机制 |
| `gateway/internal/interfaces/telegram/inbound_buffer_test.go` | InboundBuffer 测试 (×6) |
| `gateway/internal/infrastructure/grpc/model_failover_test.go` | ModelFailover 测试 (×7) |

## Phase 4 修改文件

| 文件 | 变更 |
|------|------|
| `gateway/internal/interfaces/telegram/adapter.go` | 接入 InboundBuffer; 新增 `MediaGroup` 字段; `processBufferedMessage` |
| `gateway/internal/interfaces/telegram/extensions.go` | `EditMessage` 变参 parseMode + 错误处理; 新增 `ReactMessage` |
| `gateway/internal/application/usecase/process_message.go` | 集成 Compactor + Failover; `RequestFailover` 接口 |
| `gateway/internal/application/app.go` | DI: 从 `fallback_models` 配置创建 `ModelFailover` 注入 UseCase |
| `gateway/internal/infrastructure/config/config.go` | `AgentConfig` 新增 `FallbackModels []string` |

## Phase 5 新增文件 (向量记忆系统)

| 文件 | 用途 |
|------|------|
| `gateway/internal/infrastructure/embedding/ollama_embedder.go` | Ollama HTTP 嵌入提供者 (4096 维) |
| `gateway/internal/infrastructure/embedding/ollama_embedder_test.go` | OllamaEmbedder 测试 (×4) |
| `gateway/internal/infrastructure/vectorstore/lancedb_store.go` | LanceDB 向量存储 (CGO + Arrow) |
| `gateway/env.sh` | CGO 环境变量脚本 (动态链接) |

## Phase 5 修改文件

| 文件 | 变更 |
|------|------|
| `gateway/internal/infrastructure/config/config.go` | 新增 `MemoryConfig` (ollama_url/embed_model/store_path) |
| `gateway/internal/application/app.go` | DI: `initMemorySystem()` 创建 OllamaEmbedder → LanceDBVectorStore → MemoryManager; `Stop()` 清理 |
